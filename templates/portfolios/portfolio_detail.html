{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block stylesheets %}
<link href="{% static 'core/styles/form_card.css' %}" rel="stylesheet">
<link href="{% static 'portfolios/styles/portfolio_detail.css' %}" rel="stylesheet">
{% endblock stylesheets %}


{% block content %}
<div class="modal fade" id="transactionAddModal" style="display: none;" aria-hidden="true">
    <div class="modal-dialog" role="document" style="width: 90%; max-width: 600px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal">
                </button>
            </div>

            <div class="modal-body">
                <form action="{% url 'portfolios:transaction_add' portfolio.id %}" method="post" id="transaction-add-form">
                    {% csrf_token %}
    
                    <div class="form-fields">
                        <div class="form-field">
                            <label for="name">Transaction Type</label>
                            <select class="form-control form-select" name="type">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>

                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="stock">Stock</label>
                            <select class="form-control form-select" name="stock">
                                {% for stock in stocks %}
                                    <option value="{{ stock.ticker }}">{{ stock.ticker }}</option>
                                {% endfor %}
                            </select>
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="price">Price/Cash Amount</label>
                            <input 
                                type="number" 
                                class="form-input form-control input-rounded" 
                                placeholder="Price/Cash amount (PKR)" 
                                name="price"
                                step="0.00001"
                                required
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="date">Transaction Date</label>
                            <input 
                                type="date"
                                class=" form-input form-control input-rounded" 
                                name="date"
                                max="{% now 'Y-m-d' %}"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="quantity">Quantity</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="Quantity" 
                                name="quantity"
                                required
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="brokerage_fee">Brokerage Fee (percentage or exact value)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="Brokerage Fee"
                                name="brokerage_fee" 
                                min="0"
                                step="0.00001"
                                value="{{ portfolio.brokerage_percentage }}%"
                                required
                            >
                            <small class="field-message"></small>
                        </div>

                        <button 
                            type="button" 
                            class="btn btn-square btn-outline-light btn-sm" 
                            id="price-fetch-btn"
                            data-url="{% url 'stocks:stock_latest_price' %}"
                        >
                            Fetch Current Price
                        </button>
                    </div>

                    <h5 class="form-sub-head">Additional Costs</h5>
                    <div class="form-fields">
                        <div class="form-field">
                            <label for="commission">Commission (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="Commission"
                                name="commission" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="cdc">CDC (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="CDC"
                                name="cdc" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="psx_laga">PSX LAGA (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="PSX LAGA"
                                name="psx_laga" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="secp_laga">SECP LAGA</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="SECP LAGA"
                                name="secp_laga" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="nccpl">NCCPL (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="NCCPL"
                                name="nccpl" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="cvt">CVT (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="CVT"
                                name="cvt" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="wht">WHT (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="WHT"
                                name="wht" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="adv_tax">ADV Tax (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="ADV Tax"
                                name="adv_tax" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="sst">SST (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="SST"
                                name="sst" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="submit" class="btn light btn-success btn-sm submit-btn">Add</button>
                        <button type="button" class="btn btn-danger light btn-sm" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>       
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-xl-12">
        <div class="card text-white" id="primary-card">
            <div class="card-header flex-wrap">
                <h5 class="card-title text-white">{{ portfolio.name }} Portfolio</h5>
            </div>
            <div class="tab-content" id="myTabContent4">
                <div class="tab-pane fade show active" id="Primarycard" role="tabpanel" aria-labelledby="home-tab">
                    <div class="card-body mb-0">
                        {% if portfolio.description %}
                        <p class="card-text">{{ portfolio.description }}</p>
                        {% else %}
                        <p class="card-text">No description</p>
                        {% endif %}
                    </div>
                </div>
            </div>		
        </div>
    </div>

    <section id="portfolio-stats">
        <div class="widget-stat card">
            <div class="card-body  p-4">
                <div class="media ai-icon">
                    <span class="me-3 bgl-info text-info">
                        <svg id="icon-revenue" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-dollar-sign">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </span>
                    <div class="media-body">
                        <p class="mb-1">Portfolio Capital</p>
                        <h4 class="mb-0">{{ portfolio.cash_amount }}</h4>
                        <!-- <span class="badge badge-danger">-3.5%</span> -->
                    </div>
                </div>
            </div>
        </div>

        <div class="widget-stat card">
            <div class="card-body  p-4">
                <div class="media ai-icon">
                    <span class="me-3 bgl-success text-success">
                        <svg id="icon-revenue" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-dollar-sign">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </span>
                    <div class="media-body">
                        <p class="mb-1">Portfolio Balance</p>
                        <h4 class="mb-0">{{ portfolio.balance }}</h4>
                        <!-- <span class="badge badge-danger">-3.5%</span> -->
                    </div>
                </div>
            </div>
        </div>

        <div class="widget-stat card">
            <div class="card-body p-4">
                <div class="media ai-icon">
                    <span class="me-3 bgl-danger text-danger">
                        <svg id="icon-database-widget" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-database">
                            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                        </svg>
                    </span>
                    <div class="media-body">
                        <p class="mb-1">Total Expenditure</p>
                        <h4 class="mb-0">{{ portfolio.total_expenditure }}</h4>
                        <!-- <span class="badge badge-success">-3.5%</span> -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">All Transactions</h4>
                <button 
                    type="button" 
                    class="btn btn-light btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#transactionAddModal"
                >
                    Add Transaction
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-responsive-md">
                        <thead>
                            <tr>
                                <th style="width:80px;"><small>#</small></th>
                                <th><small>Stock</small></th>
                                <th><small>Type</small></th>
                                <th><small>Quantity</small></th>
                                <th><small>Price</small></th>
                                <th><small>Net Cost</small></th>
                                <th><small>Gross Cost</small></th>
                                <th><small>Brokerage Fee</small></th>
                                <th><small>Date</small></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in portfolio.transactions.all %}
                            <tr>
                                <td><strong>{{ forloop.counter }}</strong></td>
                                <td>{{ transaction.stock.ticker }}</td>
                                <td>
                                    <span
                                        {% if transaction.type == "buy" %}
                                        class="badge light badge-success"
                                        {% else %}
                                        class="badge light badge-danger"
                                        {% endif %}
                                    >
                                        {{ transaction.type | title }}
                                    </span>
                                </td>
                                <td>{{ transaction.quantity }}</td>
                                <td>{{ transaction.price }}</td>
                                <td>{{ transaction.net_cost }}</td>
                                <td>{{ transaction.gross_cost }}</td>
                                <td>{{ transaction.brokerage_fee }}</td>
                                <td>{{ transaction.date }}</td>
                                <td>
                                    <a 
                                        href="{% url 'portfolios:transaction_delete' portfolio.id transaction.id %}" 
                                        class="btn btn-danger shadow btn-xs sharp"
                                    >
                                        <i class="fa fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script src="{% static 'core//scripts//formCard.js' %}"></script>
<script src="{% static 'portfolios//scripts//transactionAdd.js' %}"></script>
{% endblock scripts %}
 